# docker-compose.debug.yaml — debugpy overlay for Airflow services
#
# Usage:
#   docker compose -f docker-compose.yaml -f docker-compose.debug.yaml up
#
# Services (scheduler/dag-processor/apiserver/triggerer) are wrapped with
# debugpy in listen mode on dedicated ports — VS Code *connects* to them.
#
# Worker DAG debugging:
#   - Press F5 in VS Code on any DAG file (config: "Airflow: Debug Tasks (active file)")
#   - Pre-launch task starts debugpy inside the worker: --listen 0.0.0.0:5683 --wait-for-client
#   - VS Code connects on localhost:5683 -> debugpy sends configurationDone -> dag.test() runs
#
# Port assignments:
#   5679  airflow-scheduler
#   5680  airflow-dag-processor
#   5681  airflow-apiserver
#   5682  airflow-triggerer
#   5683  airflow-worker (dag.test() debugpy sessions)

services:

  airflow-scheduler:
    entrypoint: ["/usr/bin/dumb-init", "--"]
    command: ["python", "-Xfrozen_modules=off", "-m", "debugpy", "--listen", "0.0.0.0:5679", "-m", "airflow", "scheduler"]
    ports:
      - "5679:5679"

  airflow-dag-processor:
    entrypoint: ["/usr/bin/dumb-init", "--"]
    command: ["python", "-Xfrozen_modules=off", "-m", "debugpy", "--listen", "0.0.0.0:5680", "-m", "airflow", "dag-processor"]
    ports:
      - "5680:5680"

  airflow-apiserver:
    entrypoint: ["/usr/bin/dumb-init", "--"]
    command: ["python", "-Xfrozen_modules=off", "-m", "debugpy", "--listen", "0.0.0.0:5681", "-m", "airflow", "api-server"]
    ports:
      - "5681:5681"

  airflow-triggerer:
    entrypoint: ["/usr/bin/dumb-init", "--"]
    command: ["python", "-Xfrozen_modules=off", "-m", "debugpy", "--listen", "0.0.0.0:5682", "-m", "airflow", "triggerer"]
    ports:
      - "5682:5682"

  airflow-worker:
    # Port 5683 is for dag.test() debugpy sessions launched via the
    # "Airflow: Debug Tasks (active file)" VS Code config (F5 on any DAG file).
    ports:
      - "5683:5683"
